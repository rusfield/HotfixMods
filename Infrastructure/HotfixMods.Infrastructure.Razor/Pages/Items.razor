@using HotfixMods.Infrastructure.Extensions
@using HotfixMods.Infrastructure.Razor.Pages.ItemTabs
@using HotfixMods.Infrastructure.Razor.Components.Dialogs

@inject ItemService Service
@inherits HotfixPageBase

@if (null == PageTab.Dto)
{
    <TabContentView Data="new List<DashboardModel>()" New_Callback="NewAsync_Click<ItemSearch_Dialog>" Title="Items">
    </TabContentView>
}
else
{
    <TabContentEditHeader IsUpdate="false" Title="Items" ValueCompare_Callback="@(async () => ValueCompareAsync_Click<ItemSearch_Dialog>())">
        <ChildContent>
            <MudTabPanel Text="Entity">
                <TabContentEditBody>
                    <ItemEntity_Tab Value="((ItemDto)PageTab.Dto).Entity" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Item">
                <TabContentEditBody>
                    <Item_Tab Value="((ItemDto)PageTab.Dto).Item" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Item Sparse">
                <TabContentEditBody AmountOfSlides="5" CurrentSlide="currentItemSparseSlide" NavigateSlide_EventCallback="NavigateItemSparse_Click">
                    <ItemSparse_Tab Value="((ItemDto)PageTab.Dto).ItemSparse" ValueCompare="((ItemDto?)PageTab.DtoCompare)?.ItemSparse" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Material Res">
                <TabContentEditBody>
                    <ItemDisplayInfoMaterialRes_Tab Value="((ItemDto)PageTab.Dto).ItemDisplayInfoMaterialRes" ValueCompare="((ItemDto?)PageTab.DtoCompare)?.ItemDisplayInfoMaterialRes" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Display Info">
                <TabContentEditBody AmountOfSlides="2" CurrentSlide="currentItemDisplayInfoSlide" NavigateSlide_EventCallback="NavigateItemDisplayInfo_Click">
                    <ItemDisplayInfo_Tab Value="((ItemDto)PageTab.Dto).ItemDisplayInfo" ValueCompare="((ItemDto?)PageTab.DtoCompare)?.ItemDisplayInfo" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Appearance">
                <TabContentEditBody>
                    <ItemAppearance_Tab Value="((ItemDto)PageTab.Dto).ItemAppearance" ValueCompare="((ItemDto?)PageTab.DtoCompare)?.ItemAppearance" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Modified Appearance">
                <TabContentEditBody>
                    <ItemModifiedAppearance_Tab Value="((ItemDto)PageTab.Dto).ItemMItemModifiedAppearance" ValueCompare="((ItemDto?)PageTab.DtoCompare)?.ItemMItemModifiedAppearance" />
                </TabContentEditBody>
            </MudTabPanel>
            <MudTabPanel Text="Item Effects">
                <TabContentEditBody AmountOfPages="((ItemDto?)PageTab.Dto).ItemEffects.Count" AddPage_EventCallback="AddItemEffect_Click" RemovePage_EventCallback="RemoveItemEffect_Click" NavigatePage_EventCallback="NavigateEffectPage_Click" CurrentPage="currentItemEffectPage">
                    @if (((ItemDto?)PageTab.Dto).ItemEffects.Any())
                    {
                        <ItemEffect_Tab Value="((ItemDto?)PageTab.Dto)?.ItemEffects[currentItemEffectPage - 1]" ValueCompare="@(PageTab.DtoCompare != null && ((ItemDto?)PageTab.DtoCompare)?.ItemEffects.Count > currentItemEffectPage - 1 ? ((ItemDto?)PageTab.DtoCompare)?.ItemEffects[currentItemEffectPage - 1] : null)" />
                    }
                    else
                    {
                        <TabContentNoData />
                    }
                </TabContentEditBody>
            </MudTabPanel>
        </ChildContent>
    </TabContentEditHeader>
}

@code {
    int currentItemSparseSlide = 1;
    int currentItemDisplayInfoSlide = 1;

    int currentItemEffectPage = 1;

    void AddTab_Click()
    {
        if (PageTab.Dto != null)
            ((ItemDto)PageTab.Dto).ItemEffects.Add(new ItemEffect());
    }

    void RemoveTab_Click(int index)
    {
        if (PageTab.Dto != null)
            ((ItemDto)PageTab.Dto).ItemEffects.RemoveAt(index);
    }

    void NavigateItemSparse_Click(int slide)
    {
        currentItemSparseSlide = slide;
        this.StateHasChanged();
    }

    void NavigateItemDisplayInfo_Click(int slide)
    {
        currentItemDisplayInfoSlide = slide;
        this.StateHasChanged();
    }

    void AddItemEffect_Click()
    {
        if (PageTab.Dto != null)
        {
            ((ItemDto)PageTab.Dto).ItemEffects.Add(new());
            currentItemEffectPage = ((ItemDto)PageTab.Dto).ItemEffects.Count;
            this.StateHasChanged();
        }
    }

    void RemoveItemEffect_Click(int page)
    {
        if (PageTab.Dto != null && ((ItemDto)PageTab.Dto).ItemEffects.Count >= page)
            ((ItemDto)PageTab.Dto).ItemEffects.RemoveAt(page - 1);
        else
            return;

        if (currentItemEffectPage == page)
        {
            if (!((ItemDto?)PageTab.Dto).ItemEffects.Any())
                currentItemEffectPage = 0;
            else
                currentItemEffectPage = Math.Max(1, page - 1);
        }
    }

    void NavigateEffectPage_Click(int page)
    {
        currentItemEffectPage = page;
        this.StateHasChanged();
    }
}