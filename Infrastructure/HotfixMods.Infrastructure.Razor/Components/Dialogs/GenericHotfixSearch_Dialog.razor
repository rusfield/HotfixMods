@using HotfixMods.Infrastructure.Razor.Extensions
@using HotfixMods.Infrastructure.Razor.Components.Private
@using HotfixMods.Infrastructure.Razor.Handlers;

@inject GenericHotfixService Service

<DialogSearch @ref="dialogSearchRef" MudDialogInstance="Dialog">
    @if (string.IsNullOrWhiteSpace(Db2Name))
    {
        <MudText Typo="Typo.h6" Align="Align.Center">Search DB2:</MudText>
        <Input_Element @ref="Db2NameRef" Label="DB2" @bind-Value="_db2Name" GetOptionsAsync_Func="GetDefinitionNamesAsync" />
    }
    <Input_Element @ref="IdRef" @bind-Value="Id" Label="ID" OnSearchAdornmentClick="GetByIdAsync" />
</DialogSearch>



@code {
    [CascadingParameter]
    MudDialogInstance Dialog { get; set; }

    [Parameter]
    public string? Db2Name { get; set; }

    [Parameter]
    public int? Id { get; set; }

    DialogSearch? dialogSearchRef;
    Input_Element<string?>? Db2NameRef;
    Input_Element<int?>? IdRef;
    string? _db2Name;

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _db2Name = Db2Name;
            if (Id != null && _db2Name != null)
            {
                await GetByIdAsync();

                // Above function will return data if found. If not, cancel.
                Dialog.Cancel();
            }

            this.StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    async Task GetByIdAsync()
    {
        if (string.IsNullOrWhiteSpace(_db2Name))
        {
            Db2NameRef?.SetError(true);
        }

        if (null == Id)
        {
            IdRef?.SetError(true);
        }

        if (!string.IsNullOrWhiteSpace(_db2Name) && Id != null)
        {
            if (!await Service.Db2Exists(_db2Name))
            {
                dialogSearchRef?.CancelLoaderWithMessage($"DB2 {_db2Name} is not loaded.");
            }
            else
            {
                dialogSearchRef?.SetLoaderProgress("test", "test", 15);
                var data = await Service.GetByIdAsync(_db2Name, (int)Id);
                if (data != null)
                {
                    Dialog.Close(data);
                }
                else
                {
                    dialogSearchRef?.CancelLoaderWithMessage($"No DB2 record found in {_db2Name}.");
                }
            }
        }
    }

    async Task<Dictionary<string, string>> GetDefinitionNamesAsync()
    {
        if (GlobalHandler.GetFromCache<List<string>>("definitionNames") == null)
            GlobalHandler.AddToCache("definitionNames", (await Service.GetDefinitionNamesAsync()).ToList());

        return GlobalHandler.GetFromCache<List<string>>("definitionNames")!.ListToOptions<string>();
    }
}
