@page "/anim-kits"
@using HotfixMods.Infrastructure.Razor.Pages.AnimKitTabs
@using HotfixMods.Infrastructure.Razor.RazorDashboard
@using HotfixMods.Infrastructure.Razor.Components
@using HotfixMods.Infrastructure.DtoModels
@using HotfixMods.Infrastructure.DtoModels.AnimKits
@using HotfixMods.Infrastructure.Razor.Components.Dialogs
@using HotfixMods.Infrastructure.Services
@using Core.Enums

@inject IDialogService DialogService
@inject AnimKitService AnimKitService


@if (animKit != null)
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
        <MudStack Row="true">
            <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="AnimKitLookupAsync_Click">Anim Kit Lookup</MudButton>
        </MudStack>
        <MudStack Row="true">
            <MudButton Variant="Variant.Outlined" Color="Color.Success" OnClick="IdAsync_Click">@animKit.Id</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="SaveAsync_Click">@(animKit.IsUpdate ? "Update" : "Save")</MudButton>
            </MudStack>
        </MudStack>
    <MudPaper>

        <MudTabs @ref="mudTabsRef" Elevation="4" Rounded="true" Centered="true" Color="@Color.Primary" PanelClass="pa-6">
            <ChildContent>
                <MudTabPanel Text="Properties">
                    <AnimKitProperties_Tab AnimKit="animKit" AnimKitLookup="animKitLookup" />
                </MudTabPanel>
                @for (int i = 0; i < animKit.Segments.Count; i++)
                {
                    int index = i;
                    <MudTabPanel Text="@($"Segment {index}")">
                        <AnimKitSegment_Tab SegmentChanged="SegmentChanged" AnimKit="animKit" AnimKitSegment="animKit.Segments[index]" AnimKitSegmentLookup="@(animKitLookup != null && animKitLookup.Segments.Count >= index ? animKitLookup.Segments[index] : null)" />
                    </MudTabPanel>
                }
            </ChildContent>
            <Header>
                <MudTooltip Text="Add new segment">
                    <MudIconButton Icon="@Icons.Filled.Add" Style="color:white" OnClick="AddSegment_Click"/>
                </MudTooltip>
                <MudTooltip Text="Remove current segment">
                    <MudIconButton Icon="@Icons.Filled.Remove" Style="color:white" OnClick="RemoveSegment_Click" Disabled="@(animKit.Segments.Count <= 1)"/>
                </MudTooltip>
            </Header>
        </MudTabs>
    </MudPaper>
}
else
{
    <DashboardTable Data="@(dashboard)" Add="AddAsync_Click" Label="Anim Kits" />
}


@code
{
    AnimKitDto? animKit;
    AnimKitDto? animKitLookup;
    List<RazorDashboardModel> dashboard;
    MudTabs mudTabsRef;

    protected override async Task OnInitializedAsync()
    {
        dashboard = new();
        var dashboardAnimKits = await AnimKitService.GetDashboardAsync();
        foreach (var dashboardAnimKit in dashboardAnimKits)
        {
            dashboard.Add(new RazorDashboardModel(
                dashboardAnimKit.Id,
                dashboardAnimKit.Name,
                dashboardAnimKit.AvatarUrl,
                dashboardAnimKit.Comment,
                (async () => await EditAsync(dashboardAnimKit.Id)),
                (async () => await AnimKitService.DeleteAsync(dashboardAnimKit.Id))
            ));
        }
        await base.OnInitializedAsync();
    }

    async Task EditAsync(int id)
    {
        animKit = await OpenAnimKitSearchDialog(id);
        this.StateHasChanged();
    }

    async void AddAsync_Click()
    {
        animKit = await OpenAnimKitSearchDialog();
        this.StateHasChanged();
    }

    async Task AnimKitLookupAsync_Click()
    {
        animKitLookup = await OpenAnimKitSearchDialog();
        this.StateHasChanged();
    }

    async Task SaveAsync_Click()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(Prompt_Dialog.Prompt), Prompt_Dialog.PromptType.Save);
        parameters.Add(nameof(Prompt_Dialog.ActionAsync), (() => SaveAsync()));
        var result = await DialogService.Show<Prompt_Dialog>(null, parameters).Result;

        if (!result.Cancelled)
        {
            animKit.IsUpdate = true;
        }
    }

    async void SaveAsync()
    {
        await AnimKitService.SaveAsync(animKit);
    }

    async Task IdAsync_Click()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(IdButton_Dialog.Id), animKit.Id);
        parameters.Add(nameof(IdButton_Dialog.TDto), typeof(AnimKitDto));
        parameters.Add(nameof(IdButton_Dialog.TDtoIsUpdate), animKit.IsUpdate);
        var dialog = DialogService.Show<IdButton_Dialog>(null, parameters);
        var result = await dialog.Result;

        if (!result.Cancelled && (int)result.Data != -1)
        {
            animKit.Id = (int)result.Data;
            animKit.IsUpdate = false;
        }
    }

    async Task<AnimKitDto?> OpenAnimKitSearchDialog(int? id = null)
    {
        var dialogParameters = new DialogParameters();
        dialogParameters.Add(nameof(AnimKitSearch_Dialog.AnimKitId), id);
        var dialog = DialogService.Show<AnimKitSearch_Dialog>(null, dialogParameters);
        var dialogResult = await dialog.Result;
        if (!dialogResult.Cancelled)
        {
            var result = (AnimKitDto)dialogResult.Data;
            if (null != result)
            {
                return (AnimKitDto)dialogResult.Data;
            }
        }
        return null;
    }

    void AddSegment_Click()
    {
        animKit.Segments.Add(new AnimKitSegmentDto()
        {
            OrderIndex = animKit.Segments.Count()
        });
    }

    void RemoveSegment_Click()
    {
        if(animKit.Segments.Count > 1)
        {
            var currentSegment = mudTabsRef.ActivePanelIndex - 1;
            animKit.Segments.RemoveAt(currentSegment);
            for (int i = 0; i < animKit.Segments.Count; i++)
            {
                animKit.Segments[i].OrderIndex = i;
            }
            this.StateHasChanged();
        }
    }

    void SegmentChanged(int newSegment)
    {
        this.StateHasChanged();
        mudTabsRef.ActivatePanel(1 + newSegment);
    }
}

